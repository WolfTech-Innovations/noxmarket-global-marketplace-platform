class l{constructor(){this.sessionStart=Date.now(),this.features={scrollDepth:0,timeOnPage:0,hoverCount:0,hoverDuration:0,returnVisitor:!1,dayOfWeek:new Date().getDay(),hourOfDay:new Date().getHours(),mouseVelocity:[],clickCount:0,priceViews:0},this.hoverStart=null,this.lastMousePos={x:0,y:0,time:Date.now()},this.purchaseProbability=0,this.loadModel(),this.initTracking(),this.startPredictionLoop()}loadModel(){const e=localStorage.getItem("predictionData");if(this.trainingData=e?JSON.parse(e):{sessions:[],conversions:[],weights:this.initializeWeights()},localStorage.getItem("lastVisit")){this.features.returnVisitor=!0;const t=parseInt(localStorage.getItem("visitCount")||"0");localStorage.setItem("visitCount",(t+1).toString())}else localStorage.setItem("visitCount","1");localStorage.setItem("lastVisit",Date.now().toString())}saveModel(){localStorage.setItem("predictionData",JSON.stringify(this.trainingData))}initializeWeights(){return{bias:-2,scrollDepth:1.5,timeOnPage:.8,hoverCount:.6,hoverDuration:.9,returnVisitor:1.2,mouseVelocity:-.3,clickCount:.7,priceViews:1.1,hourWeight:[.3,.2,.1,.1,.2,.3,.5,.7,.9,.8,.7,.8,.9,.7,.6,.7,.8,.9,1,1.1,1,.8,.6,.4],dayWeight:[.6,.8,.9,.9,.9,.7,.5]}}initTracking(){window.addEventListener("scroll",()=>{const t=window.scrollY/(document.documentElement.scrollHeight-window.innerHeight)*100;this.features.scrollDepth=Math.max(this.features.scrollDepth,t)}),document.addEventListener("mousemove",t=>{const o=Date.now(),a=o-this.lastMousePos.time;if(a>0){const r=Math.sqrt(Math.pow(t.clientX-this.lastMousePos.x,2)+Math.pow(t.clientY-this.lastMousePos.y,2))/a;this.features.mouseVelocity.push(r),this.features.mouseVelocity.length>20&&this.features.mouseVelocity.shift()}this.lastMousePos={x:t.clientX,y:t.clientY,time:o}}),document.addEventListener("click",()=>{this.features.clickCount++});const e=document.querySelector("[data-buy-button]")||document.querySelector('button[type="submit"]')||document.querySelector(".buy-button");e&&(e.addEventListener("mouseenter",()=>{this.hoverStart=Date.now(),this.features.hoverCount++}),e.addEventListener("mouseleave",()=>{this.hoverStart&&(this.features.hoverDuration+=Date.now()-this.hoverStart,this.hoverStart=null)}));const i=document.querySelector("[data-price]")||document.querySelector(".price");i&&new IntersectionObserver(o=>{o.forEach(a=>{a.isIntersecting&&this.features.priceViews++})},{threshold:.5}).observe(i),document.addEventListener("visibilitychange",()=>{document.hidden?this.features.timeOnPage+=(Date.now()-this.sessionStart)/1e3:this.sessionStart=Date.now()})}normalizeFeatures(){const e=this.features.mouseVelocity.length>0?this.features.mouseVelocity.reduce((i,t)=>i+t,0)/this.features.mouseVelocity.length:0;return{scrollDepth:this.features.scrollDepth/100,timeOnPage:Math.min(this.features.timeOnPage/300,1),hoverCount:Math.min(this.features.hoverCount/10,1),hoverDuration:Math.min(this.features.hoverDuration/5e3,1),returnVisitor:this.features.returnVisitor?1:0,mouseVelocity:Math.min(e,1),clickCount:Math.min(this.features.clickCount/20,1),priceViews:Math.min(this.features.priceViews/5,1)}}sigmoid(e){return 1/(1+Math.exp(-e))}predict(){const e=this.trainingData.weights,i=this.normalizeFeatures();let t=e.bias;return t+=i.scrollDepth*e.scrollDepth,t+=i.timeOnPage*e.timeOnPage,t+=i.hoverCount*e.hoverCount,t+=i.hoverDuration*e.hoverDuration,t+=i.returnVisitor*e.returnVisitor,t+=i.mouseVelocity*e.mouseVelocity,t+=i.clickCount*e.clickCount,t+=i.priceViews*e.priceViews,t+=e.hourWeight[this.features.hourOfDay]*.5,t+=e.dayWeight[this.features.dayOfWeek]*.5,this.sigmoid(t)}startPredictionLoop(){setInterval(()=>{this.features.timeOnPage=(Date.now()-this.sessionStart)/1e3,this.purchaseProbability=this.predict(),window.dispatchEvent(new CustomEvent("predictionUpdate",{detail:{probability:this.purchaseProbability,features:this.features,confidence:this.getConfidence()}})),this.optimizeUI()},2e3)}getConfidence(){const e=this.trainingData.sessions.length;return e<10?"low":e<50?"medium":"high"}optimizeUI(){const e=this.purchaseProbability;e<.3&&this.features.timeOnPage>10?this.showUrgency():e>=.3&&e<.6?this.encourageAction():e>=.6&&this.removeFriction()}showUrgency(){const e=document.querySelector("[data-urgency]");e&&!e.classList.contains("active")&&(e.classList.add("active"),e.innerHTML="âš¡ Limited stock - Order now!")}encourageAction(){const e=document.querySelector("[data-buy-button]");e&&!e.classList.contains("highlighted")&&(e.classList.add("highlighted"),e.style.transform="scale(1.02)",e.style.transition="transform 0.3s ease")}removeFriction(){document.querySelectorAll("[data-hide-on-intent]").forEach(i=>{i.style.opacity="0.3",i.style.pointerEvents="none"})}recordConversion(e=!0){this.trainingData.sessions.push({features:this.normalizeFeatures(),rawFeatures:{...this.features},purchased:e,timestamp:Date.now()}),this.trainingData.sessions.length>=5&&this.trainModel(),this.saveModel()}trainModel(){for(let t=0;t<50;t++)this.trainingData.sessions.forEach(o=>{const a=this.predictFromFeatures(o.features),s=(o.purchased?1:0)-a,r=this.trainingData.weights;r.bias+=.01*s,r.scrollDepth+=.01*s*o.features.scrollDepth,r.timeOnPage+=.01*s*o.features.timeOnPage,r.hoverCount+=.01*s*o.features.hoverCount,r.hoverDuration+=.01*s*o.features.hoverDuration,r.returnVisitor+=.01*s*o.features.returnVisitor,r.mouseVelocity+=.01*s*o.features.mouseVelocity,r.clickCount+=.01*s*o.features.clickCount,r.priceViews+=.01*s*o.features.priceViews})}predictFromFeatures(e){const i=this.trainingData.weights;let t=i.bias;return t+=e.scrollDepth*i.scrollDepth,t+=e.timeOnPage*i.timeOnPage,t+=e.hoverCount*i.hoverCount,t+=e.hoverDuration*i.hoverDuration,t+=e.returnVisitor*i.returnVisitor,t+=e.mouseVelocity*i.mouseVelocity,t+=e.clickCount*i.clickCount,t+=e.priceViews*i.priceViews,this.sigmoid(t)}getPrediction(){return{probability:this.purchaseProbability,confidence:this.getConfidence(),features:this.features,recommendation:this.getRecommendation()}}getRecommendation(){const e=this.purchaseProbability;return e<.3?"Show urgency or offer":e<.6?"Encourage with social proof":"User is ready - minimize friction"}reset(){localStorage.removeItem("predictionData"),localStorage.removeItem("lastVisit"),localStorage.removeItem("visitCount"),this.trainingData={sessions:[],conversions:[],weights:this.initializeWeights()}}}const c=new l;window.addEventListener("predictionUpdate",n=>{console.log("Purchase Probability:",(n.detail.probability*100).toFixed(1)+"%"),console.log("Confidence:",n.detail.confidence);const e=document.querySelector("[data-prediction-debug]");e&&(e.innerHTML=`
      <div>Probability: ${(n.detail.probability*100).toFixed(1)}%</div>
      <div>Confidence: ${n.detail.confidence}</div>
      <div>Time on page: ${n.detail.features.timeOnPage.toFixed(0)}s</div>
      <div>Scroll depth: ${n.detail.features.scrollDepth.toFixed(0)}%</div>
    `)});window.recordPurchase=function(){c.recordConversion(!0),console.log("Purchase recorded! Model will learn from this session.")};window.addEventListener("beforeunload",()=>{c.features.timeOnPage>5&&c.recordConversion(!1)});window.predictor=c;console.log("Prediction Engine Active");console.log("Use predictor.getPrediction() to see current analysis");console.log("Use predictor.reset() to clear training data");
