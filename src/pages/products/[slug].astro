---
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import { getProduct } from '@/lib/cosmic';
import { generateProductJsonLd } from '@/lib/seo';
import { getSessionFromCookies } from '@/lib/auth';

const session = getSessionFromCookies(Astro.cookies);
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/products');
}

let product;
try {
  product = await getProduct(slug);
} catch (error) {
  console.error('Error fetching product:', error);
  return Astro.redirect('/404');
}

if (!product) {
  return Astro.redirect('/404');
}

// Normalize product images
let productImages = product.metadata.product_images;
if (!productImages) {
  productImages = [];
} else if (!Array.isArray(productImages)) {
  productImages = [productImages];
} else {
  productImages = productImages.filter(img => img && (img.imgix_url || img.url));
}

const primaryImage = productImages[0];
const imageUrl = primaryImage?.imgix_url 
  ? `${primaryImage.imgix_url}?w=1200&h=1200&fit=crop&auto=format,compress` 
  : primaryImage?.url || '';

const price = product.metadata.price ?? 0;
const formattedPrice = price > 0 ? `$${price.toFixed(2)}` : 'Price not available';
const inStock = product.metadata.in_stock ?? false;
const stockQuantity = product.metadata.stock_quantity ?? 0;

const seller = product.metadata.seller;
const sellerName = seller?.metadata?.business_name || seller?.title || 'Unknown Seller';

const category = product.metadata.category;
const categoryName = category?.metadata?.category_name || 'Uncategorized';
const categoryIcon = category?.metadata?.category_icon;

const baseUrl = import.meta.env.SITE || 'https://nox.wolfos.uk';
let jsonLd;

try {
  jsonLd = generateProductJsonLd(product, baseUrl);
} catch (error) {
  console.error('Error generating JSON-LD:', error);
  jsonLd = {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": product.metadata.product_name,
    "description": product.metadata.description?.substring(0, 160) || '',
    ...(imageUrl && { "image": imageUrl }),
    "offers": {
      "@type": "Offer",
      "price": price,
      "priceCurrency": "USD",
      "availability": inStock ? "https://schema.org/InStock" : "https://schema.org/OutOfStock"
    }
  };
}
---

<Layout 
  title={`${product.metadata.product_name} - Nox`}
  description={product.metadata.description?.substring(0, 160) || `Buy ${product.metadata.product_name} on Nox`}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} is:inline />
    <meta property="og:title" content={`${product.metadata.product_name} - Nox`} />
    {product.metadata.description && (
      <meta property="og:description" content={product.metadata.description.substring(0, 160)} />
    )}
    {imageUrl && <meta property="og:image" content={imageUrl} />}
    <meta property="og:type" content="product" />
    <meta property="product:price:amount" content={price.toString()} />
    <meta property="product:price:currency" content="USD" />
  </Fragment>

  <Header />

  <main class="py-16">
    <div class="container-custom">
      <!-- Breadcrumb -->
      <nav class="mb-8 text-sm" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 text-gray-600">
          <li><a href="/" class="hover:text-blue-600 transition-colors">Home</a></li>
          <li><span class="text-gray-400">/</span></li>
          <li><a href="/products" class="hover:text-blue-600 transition-colors">Components</a></li>
          {category && (
            <>
              <li><span class="text-gray-400">/</span></li>
              <li><a href={`/products?category=${category.slug}`} class="hover:text-blue-600 transition-colors">{categoryName}</a></li>
            </>
          )}
          <li><span class="text-gray-400">/</span></li>
          <li class="text-gray-900 font-medium truncate" aria-current="page">{product.metadata.product_name}</li>
        </ol>
      </nav>

      <div class="grid lg:grid-cols-2 gap-12">
        <!-- Product Images -->
        <div>
          {imageUrl ? (
            <div class="sticky top-4">
              <div class="aspect-square rounded-3xl overflow-hidden bg-gray-100 elevation-2">
                <img 
                  src={imageUrl}
                  alt={product.metadata.product_name}
                  class="w-full h-full object-cover"
                  width="600"
                  height="600"
                  loading="eager"
                />
              </div>

              {productImages.length > 1 && (
                <div class="mt-4 grid grid-cols-4 gap-2">
                  {productImages.slice(1, 5).map((img: { url: string; imgix_url: string }) => {
                    const thumbUrl = img.imgix_url ? `${img.imgix_url}?w=200&h=200&fit=crop` : img.url;
                    return thumbUrl ? (
                      <div class="aspect-square rounded-2xl overflow-hidden bg-gray-100 border-2 border-transparent hover:border-blue-500 transition-all cursor-pointer">
                        <img src={thumbUrl} alt={`${product.metadata.product_name} view`} class="w-full h-full object-cover" loading="lazy" />
                      </div>
                    ) : null;
                  })}
                </div>
              )}
            </div>
          ) : (
            <div class="aspect-square rounded-3xl bg-gray-200 flex items-center justify-center">
              <svg class="w-24 h-24 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </div>
          )}
        </div>

        <!-- Product Details -->
        <div>
          <h1 class="text-5xl font-medium tracking-tight text-gray-900 mb-4">{product.metadata.product_name}</h1>

          <!-- Price & Stock -->
          <div class="flex items-center gap-4 mb-8 pb-8 border-b">
            <span class="text-5xl font-medium text-gray-900">{formattedPrice}</span>
            {inStock ? (
              <span class="chip bg-green-100 text-green-800">In Stock ({stockQuantity})</span>
            ) : (
              <span class="chip bg-red-100 text-red-800">Out of Stock</span>
            )}
          </div>

          <!-- Seller -->
          {seller && (
            <div class="mb-8 p-6 card-elevated">
              <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold mb-3">Sold by</p>
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-lg">
                  {sellerName.charAt(0).toUpperCase()}
                </div>
                <div>
                  <p class="font-semibold text-lg text-gray-900">{sellerName}</p>
                  <a href="#" class="text-sm text-blue-600 hover:underline">View seller profile</a>
                </div>
              </div>
            </div>
          )}

          <!-- Description -->
          <div class="mb-8">
            <h2 class="text-2xl font-medium text-gray-900 mb-4">Description</h2>
            <div class="prose text-gray-700" set:html={product.metadata.description || 'No description available.'} />
          </div>

          <!-- PC Specs (if available) -->
          {(product.metadata.condition || product.metadata.benchmark_results) && (
            <div class="mb-8 p-6 card-elevated bg-gradient-to-br from-blue-50 to-indigo-50">
              <h3 class="text-xl font-medium text-gray-900 mb-4">Component Details</h3>
              <div class="space-y-3">
                {product.metadata.condition && (
                  <div class="flex justify-between">
                    <span class="text-gray-600">Condition:</span>
                    <span class="font-medium text-gray-900">{product.metadata.condition}</span>
                  </div>
                )}
                {product.metadata.benchmark_results && (
                  <div>
                    <span class="text-gray-600 block mb-2">Benchmarks:</span>
                    <p class="text-sm text-gray-900 bg-white p-3 rounded-lg">{product.metadata.benchmark_results}</p>
                  </div>
                )}
                {product.metadata.warranty_info && (
                  <div class="flex justify-between">
                    <span class="text-gray-600">Warranty:</span>
                    <span class="font-medium text-gray-900">{product.metadata.warranty_info}</span>
                  </div>
                )}
              </div>
            </div>
          )}

          <!-- Buy Button -->
          {inStock ? (
            session ? (
              <a 
                href={`/checkout/${product.id}`}
                class="btn btn-primary w-full text-lg py-4 text-center block"
              >
                Buy Now - {formattedPrice}
              </a>
            ) : (
              <a 
                href={`/login?redirect=/checkout/${product.id}`}
                class="btn btn-primary w-full text-lg py-4 text-center block"
              >
                Login to Purchase
              </a>
            )
          ) : (
            <div class="p-6 card-elevated text-center">
              <p class="text-gray-600 font-medium mb-2">Currently Unavailable</p>
              <p class="text-sm text-gray-500">This component is out of stock</p>
            </div>
          )}

          <!-- Category -->
          {category && (
            <div class="mt-8 pt-8 border-t">
              <p class="text-xs uppercase tracking-wider text-gray-500 font-semibold mb-3">Category</p>
              <a 
                href={`/products?category=${category.slug}`}
                class="inline-flex items-center gap-3 px-5 py-3 card state-layer"
              >
                {categoryIcon?.imgix_url && (
                  <img src={`${categoryIcon.imgix_url}?w=40&h=40&fit=crop`} alt="" class="w-6 h-6 rounded-full" />
                )}
                <span class="font-semibold text-gray-900">{categoryName}</span>
              </a>
            </div>
          )}
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>